<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Admin - Centiwize</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            color: #333;
        }
        .header {
            background: linear-gradient(135deg, #1a5f2a 0%, #2d8f47 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
        }
        .header h1 { font-size: 1.4rem; }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .header-right span { font-size: 0.9rem; opacity: 0.9; }
        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 6px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }

        /* Login Gate */
        .login-gate {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a5f2a 0%, #2d8f47 50%, #45b86a 100%);
        }
        .login-card {
            background: white;
            border-radius: 15px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .login-card h2 { color: #1a5f2a; margin-bottom: 10px; }
        .login-card p { color: #666; margin-bottom: 25px; }
        .github-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: #24292e;
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .github-btn:hover { background: #444d56; }
        .github-btn svg { width: 22px; height: 22px; }
        .error-msg { color: #c62828; background: #ffebee; padding: 12px; border-radius: 8px; margin-top: 15px; font-size: 0.9rem; }
        .spinner { width: 36px; height: 36px; border: 4px solid #e0e0e0; border-top-color: #1a5f2a; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 20px auto; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Dashboard */
        .dashboard { display: none; }
        .container { max-width: 1100px; margin: 0 auto; padding: 25px 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .stat-card .label { color: #888; font-size: 0.85rem; margin-bottom: 5px; }
        .stat-card .value { font-size: 1.8rem; font-weight: 700; color: #1a5f2a; }

        .controls { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 10px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95rem;
            outline: none;
        }
        .search-input:focus { border-color: #1a5f2a; }
        .refresh-btn {
            background: #1a5f2a;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        .refresh-btn:hover { background: #155223; }

        .users-table {
            width: 100%;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border-collapse: collapse;
        }
        .users-table th {
            background: #f8f9fa;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
            color: #555;
            border-bottom: 2px solid #e0e0e0;
        }
        .users-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.9rem;
        }
        .users-table tr:hover td { background: #f8fdf9; }
        .provider-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: capitalize;
        }
        .provider-badge.email { background: #e3f2fd; color: #1565c0; }
        .provider-badge.google { background: #fce4ec; color: #c62828; }
        .provider-badge.github { background: #f3e5f5; color: #6a1b9a; }
        .provider-badge.apple { background: #e0e0e0; color: #333; }
        .provider-badge.phone { background: #e8f5e9; color: #2e7d32; }

        .action-btn {
            padding: 4px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            font-size: 0.8rem;
            margin-right: 4px;
        }
        .action-btn:hover { background: #f5f5f5; }
        .action-btn.delete { color: #c62828; border-color: #ffcdd2; }
        .action-btn.delete:hover { background: #ffebee; }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
        }
        .page-btn {
            padding: 8px 14px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .page-btn:hover { background: #f5f5f5; }
        .page-btn.active { background: #1a5f2a; color: white; border-color: #1a5f2a; }
        .page-btn:disabled { opacity: 0.4; cursor: not-allowed; }

        /* Confirm Modal */
        .confirm-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .confirm-overlay.active { display: flex; }
        .confirm-modal {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .confirm-modal h3 { margin-bottom: 10px; color: #c62828; }
        .confirm-modal p { color: #666; margin-bottom: 20px; font-size: 0.95rem; }
        .confirm-actions { display: flex; gap: 10px; justify-content: center; }
        .confirm-actions button {
            padding: 10px 24px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-cancel { background: #e0e0e0; color: #333; }
        .btn-cancel:hover { background: #ccc; }
        .btn-danger { background: #c62828; color: white; }
        .btn-danger:hover { background: #a51e1e; }

        .empty-state { text-align: center; padding: 40px; color: #999; }

        @media (max-width: 600px) {
            .users-table { font-size: 0.8rem; }
            .users-table th, .users-table td { padding: 8px 10px; }
            .header { padding: 12px 15px; }
            .header h1 { font-size: 1.1rem; }
        }
    </style>
</head>
<body>
    <!-- Login Gate -->
    <div id="loginGate" class="login-gate">
        <div class="login-card">
            <h2>Centiwize Admin</h2>
            <p>Sign in with GitHub to access the admin panel.</p>
            <div id="loginSpinner" class="spinner" style="display: none;"></div>
            <button class="github-btn" id="githubLoginBtn" onclick="adminLogin()">
                <svg viewBox="0 0 24 24"><path fill="white" d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
                Login with GitHub
            </button>
            <div id="loginError" class="error-msg" style="display: none;"></div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <div class="header">
            <h1>Centiwize Admin</h1>
            <div class="header-right">
                <span id="adminName"></span>
                <button class="logout-btn" onclick="adminLogout()">Logout</button>
            </div>
        </div>

        <div class="container">
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card"><div class="label">Total Users</div><div class="value" id="statTotal">-</div></div>
                <div class="stat-card"><div class="label">Last 7 Days</div><div class="value" id="statWeek">-</div></div>
                <div class="stat-card"><div class="label">Last 30 Days</div><div class="value" id="statMonth">-</div></div>
                <div class="stat-card"><div class="label">Confirmed</div><div class="value" id="statConfirmed">-</div></div>
            </div>

            <div class="controls">
                <input type="text" class="search-input" id="searchInput" placeholder="Search by email or name..." oninput="debounceSearch()">
                <button class="refresh-btn" onclick="loadData()">Refresh</button>
            </div>

            <table class="users-table">
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Name</th>
                        <th>Provider</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersBody">
                    <tr><td colspan="5" class="empty-state">Loading...</td></tr>
                </tbody>
            </table>

            <div class="pagination" id="pagination"></div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="confirm-overlay" id="confirmModal">
        <div class="confirm-modal">
            <h3>Delete User</h3>
            <p id="confirmText">Are you sure you want to delete this user? This action cannot be undone.</p>
            <div class="confirm-actions">
                <button class="btn-cancel" onclick="closeConfirm()">Cancel</button>
                <button class="btn-danger" id="confirmDeleteBtn" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <script>
        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        let currentPage = 1;
        const perPage = 20;
        let searchQuery = '';
        let deleteUserId = null;
        let searchTimeout = null;

        // Check session on load
        (async function init() {
            try {
                const sessionRes = await fetch('/api/auth/session', { credentials: 'include' });
                const sessionData = await sessionRes.json();

                if (sessionData.success && sessionData.user) {
                    // Verify admin access
                    const statsRes = await fetch('/api/admin/stats', { credentials: 'include' });

                    if (statsRes.ok) {
                        showDashboard(sessionData.user);
                        return;
                    }

                    if (statsRes.status === 403) {
                        showLoginError('Access denied: your GitHub account does not have admin privileges.');
                        return;
                    }
                }
            } catch (e) {}

            // Show login gate
            document.getElementById('loginGate').style.display = 'flex';
        })();

        function showLoginError(msg) {
            document.getElementById('loginGate').style.display = 'flex';
            document.getElementById('githubLoginBtn').style.display = 'inline-flex';
            document.getElementById('loginSpinner').style.display = 'none';
            const err = document.getElementById('loginError');
            err.textContent = msg;
            err.style.display = 'block';
        }

        async function adminLogin() {
            try {
                localStorage.setItem('auth_redirect', window.location.pathname);
                const response = await fetch('/api/auth/oauth/github');
                const data = await response.json();
                if (data.url) {
                    window.location.href = data.url;
                } else {
                    showLoginError('Failed to start GitHub login');
                }
            } catch (error) {
                showLoginError(error.message);
            }
        }

        async function adminLogout() {
            await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
            window.location.reload();
        }

        async function showDashboard(user) {
            document.getElementById('loginGate').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            const name = user.user_metadata?.full_name || user.user_metadata?.user_name || 'Admin';
            document.getElementById('adminName').textContent = name;
            loadData();
        }

        async function loadData() {
            await Promise.all([loadStats(), loadUsers()]);
        }

        async function loadStats() {
            try {
                const res = await fetch('/api/admin/stats', { credentials: 'include' });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('statTotal').textContent = data.total_users;
                    document.getElementById('statWeek').textContent = data.last_7_days;
                    document.getElementById('statMonth').textContent = data.last_30_days;
                    document.getElementById('statConfirmed').textContent = data.confirmed;
                }
            } catch (e) {
                console.error('Failed to load stats:', e);
            }
        }

        async function loadUsers() {
            try {
                const params = new URLSearchParams({ page: currentPage, per_page: perPage });
                if (searchQuery) params.set('search', searchQuery);

                const res = await fetch(`/api/admin/users?${params}`, { credentials: 'include' });

                if (res.status === 401 || res.status === 403) {
                    window.location.reload();
                    return;
                }

                const data = await res.json();
                if (!data.success) return;

                renderUsers(data.users);
                renderPagination(data.total);
            } catch (e) {
                console.error('Failed to load users:', e);
            }
        }

        function renderUsers(users) {
            const tbody = document.getElementById('usersBody');

            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No users found</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(u => {
                const email = escapeHtml(u.email || '-');
                const name = escapeHtml(u.user_metadata?.full_name || '-');
                const provider = getProvider(u);
                const created = u.created_at ? new Date(u.created_at).toLocaleDateString() : '-';
                const hasEmail = !!u.email;

                return `<tr>
                    <td>${email}</td>
                    <td>${name}</td>
                    <td><span class="provider-badge ${escapeHtml(provider)}">${escapeHtml(provider)}</span></td>
                    <td>${escapeHtml(created)}</td>
                    <td>
                        ${hasEmail ? `<button class="action-btn" onclick="resetPassword('${escapeHtml(u.id)}')">Reset PW</button>` : ''}
                        <button class="action-btn delete" onclick="showDeleteConfirm('${escapeHtml(u.id)}', '${escapeHtml(email)}')">Delete</button>
                    </td>
                </tr>`;
            }).join('');
        }

        function getProvider(user) {
            const identities = user.identities || [];
            if (identities.length > 0) {
                return identities[0].provider || 'email';
            }
            if (user.phone) return 'phone';
            return 'email';
        }

        function renderPagination(total) {
            const pages = Math.ceil(total / perPage);
            const container = document.getElementById('pagination');

            if (pages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = `<button class="page-btn" ${currentPage <= 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">Prev</button>`;

            for (let i = 1; i <= pages && i <= 10; i++) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            }

            html += `<button class="page-btn" ${currentPage >= pages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">Next</button>`;
            container.innerHTML = html;
        }

        function goToPage(page) {
            currentPage = page;
            loadUsers();
        }

        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchQuery = document.getElementById('searchInput').value.trim();
                currentPage = 1;
                loadUsers();
            }, 300);
        }

        function showDeleteConfirm(userId, email) {
            deleteUserId = userId;
            document.getElementById('confirmText').textContent = `Are you sure you want to delete ${email}? This action cannot be undone.`;
            document.getElementById('confirmModal').classList.add('active');
        }

        function closeConfirm() {
            deleteUserId = null;
            document.getElementById('confirmModal').classList.remove('active');
        }

        async function confirmDelete() {
            if (!deleteUserId) return;

            const btn = document.getElementById('confirmDeleteBtn');
            btn.disabled = true;
            btn.textContent = 'Deleting...';

            try {
                const res = await fetch(`/api/admin/users/${deleteUserId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const data = await res.json();

                if (res.status === 400) {
                    alert(data.detail || 'Cannot delete this user');
                } else if (!res.ok) {
                    alert('Failed to delete user');
                } else {
                    loadData();
                }
            } catch (e) {
                alert('Error: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Delete';
                closeConfirm();
            }
        }

        async function resetPassword(userId) {
            if (!confirm('Send a password reset email to this user?')) return;

            try {
                const res = await fetch(`/api/admin/users/${userId}/reset-password`, {
                    method: 'POST',
                    credentials: 'include'
                });

                const data = await res.json();

                if (data.success) {
                    alert(data.message || 'Password reset email sent');
                } else {
                    alert(data.detail || data.error || 'Failed to send reset email');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }
    </script>
</body>
</html>
