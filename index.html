<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy ROI Calculator - Netherlands</title>
    <meta name="description" content="Calculate your energy savings potential with the Centiwize Energy ROI Calculator. Get personalized recommendations for solar panels, insulation, heat pumps, and more for Dutch homes.">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a5f2a 0%, #2d8f47 50%, #45b86a 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h1 {
            color: #1a5f2a;
            font-size: 1.5rem;
            margin-bottom: 2px;
        }

        .header-left p {
            color: #666;
            font-size: 0.85rem;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .auth-btn {
            background: #1a5f2a;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .auth-btn.secondary {
            background: transparent;
            color: #1a5f2a;
            border: 2px solid #1a5f2a;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            background: #f0f7f1;
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #1a5f2a;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .notification-badge {
            position: relative;
        }

        .notification-badge .count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff6b6b;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h2 {
            color: #1a5f2a;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-close {
            float: right;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .tab-btn.active {
            border-color: #1a5f2a;
            background: #e8f5e9;
            color: #1a5f2a;
        }

        .auth-error {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .auth-success {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .social-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .social-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 11px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            color: #333;
            transition: all 0.2s;
        }

        .social-btn:hover { border-color: #bbb; background: #fafafa; }
        .social-btn.google:hover { border-color: #4285f4; background: #f0f4ff; }
        .social-btn.github:hover { border-color: #333; background: #f5f5f5; }
        .social-btn.apple:hover { border-color: #000; background: #f5f5f5; }

        .social-btn svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .auth-divider {
            display: flex;
            align-items: center;
            margin: 15px 0;
            color: #999;
            font-size: 0.85rem;
        }

        .auth-divider::before,
        .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #e0e0e0;
        }

        .auth-divider span {
            padding: 0 12px;
        }

        /* Notification Panel */
        .notification-panel {
            display: none;
            position: absolute;
            top: 60px;
            right: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            width: 350px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 999;
        }

        .notification-panel.active {
            display: block;
        }

        .notification-panel h3 {
            padding: 15px;
            border-bottom: 1px solid #eee;
            margin: 0;
        }

        .notification-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .notification-item:hover {
            background: #f5f5f5;
        }

        .notification-item.unread {
            background: #e8f5e9;
        }

        .notification-item .title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .notification-item .message {
            font-size: 0.85rem;
            color: #666;
        }

        .notification-item .time {
            font-size: 0.75rem;
            color: #999;
            margin-top: 5px;
        }

        /* Dashboard Styles */
        .dashboard-section {
            display: none;
        }

        .dashboard-section.active {
            display: block;
        }

        .saved-calc-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .saved-calc-item .info h4 {
            margin: 0 0 5px 0;
            color: #1a5f2a;
        }

        .saved-calc-item .info p {
            margin: 0;
            font-size: 0.85rem;
            color: #666;
        }

        .saved-calc-item .savings {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1a5f2a;
        }

        .container {
            max-width: 900px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .card h2 {
            color: #1a5f2a;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2 .icon {
            font-size: 1.5rem;
        }

        .required-badge {
            background: #ff6b6b;
            color: white;
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 10px;
            margin-left: 10px;
        }

        .optional-badge {
            background: #6c757d;
            color: white;
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 10px;
            margin-left: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #444;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2d8f47;
        }

        .form-group .hint {
            font-size: 0.85rem;
            color: #888;
            margin-top: 5px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .improvements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .improvement-item {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .improvement-item:hover {
            border-color: #2d8f47;
            transform: translateY(-2px);
        }

        .improvement-item.selected {
            background: #e8f5e9;
            border-color: #2d8f47;
        }

        .improvement-item input[type="checkbox"] {
            margin-right: 10px;
        }

        .improvement-item .name {
            font-weight: 600;
            color: #333;
        }

        .improvement-item .cost {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        .improvement-item .savings {
            font-size: 0.85rem;
            color: #2d8f47;
            margin-top: 3px;
        }

        .btn {
            background: linear-gradient(135deg, #1a5f2a 0%, #2d8f47 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            display: block;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(45, 143, 71, 0.4);
        }

        .results {
            display: none;
        }

        .results.visible {
            display: block;
        }

        .results-summary {
            background: linear-gradient(135deg, #1a5f2a 0%, #2d8f47 100%);
            color: white;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-bottom: 25px;
        }

        .results-summary h2 {
            color: white;
            border-bottom: none;
            justify-content: center;
        }

        .savings-amount {
            font-size: 3rem;
            font-weight: 700;
            margin: 20px 0;
        }

        .savings-period {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .result-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .result-card h3 {
            color: #1a5f2a;
            margin-bottom: 10px;
        }

        .result-card .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #333;
        }

        .result-card .label {
            color: #666;
            font-size: 0.9rem;
        }

        .payback-bar {
            background: #e0e0e0;
            border-radius: 10px;
            height: 20px;
            margin-top: 15px;
            overflow: hidden;
        }

        .payback-bar .fill {
            background: linear-gradient(90deg, #2d8f47, #45b86a);
            height: 100%;
            border-radius: 10px;
            transition: width 1s ease-out;
        }

        .energy-method-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .energy-method-tabs button {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .energy-method-tabs button.active {
            border-color: #2d8f47;
            background: #e8f5e9;
            color: #1a5f2a;
        }

        .energy-method-content {
            display: none;
        }

        .energy-method-content.active {
            display: block;
        }

        .footer {
            text-align: center;
            padding: 30px;
            color: rgba(255,255,255,0.8);
        }

        .footer a {
            color: white;
        }

        /* Fix placeholder text-transform for uppercase inputs */
        input[style*="text-transform: uppercase"]::placeholder {
            text-transform: none;
        }
        #postalCodeLookup::placeholder {
            text-transform: none;
        }

        .collapsible {
            cursor: pointer;
            user-select: none;
        }

        .collapsible::after {
            content: ' +';
            font-weight: bold;
        }

        .collapsible.open::after {
            content: ' -';
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.open {
            max-height: 2000px;
        }
    </style>
</head>
<body>
    <!-- Auth Modal -->
    <div class="modal-overlay" id="authModal">
        <div class="modal">
            <button class="modal-close" onclick="closeAuthModal()">&times;</button>
            <h2 id="authModalTitle">Welcome</h2>

            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchAuthTab('login')">Login</button>
                <button class="tab-btn" onclick="switchAuthTab('register')">Register</button>
            </div>

            <div id="authError" class="auth-error" style="display: none;"></div>
            <div id="authSuccess" class="auth-success" style="display: none;"></div>

            <!-- Login Form -->
            <div id="loginForm">
                <div class="social-buttons">
                    <button class="social-btn google" onclick="handleOAuthLogin('google')">
                        <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                        Continue with Google
                    </button>
                    <button class="social-btn github" onclick="handleOAuthLogin('github')">
                        <svg viewBox="0 0 24 24"><path fill="#333" d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
                        Continue with GitHub
                    </button>
                    <button class="social-btn apple" onclick="handleOAuthLogin('apple')">
                        <svg viewBox="0 0 24 24"><path fill="#000" d="M17.05 20.28c-.98.95-2.05.88-3.08.4-1.09-.5-2.08-.52-3.23 0-1.44.62-2.2.44-3.06-.4C3.79 16.17 4.36 9.53 8.7 9.28c1.23.06 2.08.72 2.8.75.99-.2 1.93-.77 2.98-.7 1.26.1 2.2.58 2.82 1.49-2.58 1.55-1.97 4.96.48 5.91-.57 1.52-1.31 3.01-2.73 4.55zM12.03 9.2C11.88 7.14 13.54 5.42 15.5 5.25c.3 2.32-2.1 4.06-3.47 3.95z"/></svg>
                        Continue with Apple
                    </button>
                </div>
                <div class="auth-divider"><span>or continue with email</span></div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" placeholder="Your password">
                </div>
                <button class="btn" onclick="handleLogin()" style="margin-top: 10px;">Login</button>
                <p style="text-align: center; margin-top: 15px; font-size: 0.85rem;">
                    <a href="#" onclick="showForgotPassword()" style="color: #1a5f2a;">Forgot password?</a>
                </p>
            </div>

            <!-- Register Form -->
            <div id="registerForm" style="display: none;">
                <div class="social-buttons">
                    <button class="social-btn google" onclick="handleOAuthLogin('google')">
                        <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                        Continue with Google
                    </button>
                    <button class="social-btn github" onclick="handleOAuthLogin('github')">
                        <svg viewBox="0 0 24 24"><path fill="#333" d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
                        Continue with GitHub
                    </button>
                    <button class="social-btn apple" onclick="handleOAuthLogin('apple')">
                        <svg viewBox="0 0 24 24"><path fill="#000" d="M17.05 20.28c-.98.95-2.05.88-3.08.4-1.09-.5-2.08-.52-3.23 0-1.44.62-2.2.44-3.06-.4C3.79 16.17 4.36 9.53 8.7 9.28c1.23.06 2.08.72 2.8.75.99-.2 1.93-.77 2.98-.7 1.26.1 2.2.58 2.82 1.49-2.58 1.55-1.97 4.96.48 5.91-.57 1.52-1.31 3.01-2.73 4.55zM12.03 9.2C11.88 7.14 13.54 5.42 15.5 5.25c.3 2.32-2.1 4.06-3.47 3.95z"/></svg>
                        Continue with Apple
                    </button>
                </div>
                <div class="auth-divider"><span>or continue with email</span></div>
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="registerName" placeholder="Your name">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="registerEmail" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>Phone (optional)</label>
                    <input type="tel" id="registerPhone" placeholder="+31 6 12345678">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="registerPassword" placeholder="Min. 6 characters">
                </div>
                <button class="btn" onclick="handleRegister()" style="margin-top: 10px;">Create Account</button>
            </div>

            <!-- Forgot Password Form -->
            <div id="forgotForm" style="display: none;">
                <p style="margin-bottom: 15px; color: #666;">Enter your email to receive a password reset link.</p>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="forgotEmail" placeholder="your@email.com">
                </div>
                <button class="btn" onclick="handleForgotPassword()" style="margin-top: 10px;">Send Reset Link</button>
                <p style="text-align: center; margin-top: 15px;">
                    <a href="#" onclick="switchAuthTab('login')" style="color: #1a5f2a;">Back to login</a>
                </p>
            </div>

        </div>
    </div>

    <!-- Notification Panel -->
    <div class="notification-panel" id="notificationPanel">
        <h3>Notifications <span id="notifCount" style="font-weight: normal; color: #666; font-size: 0.85rem;"></span></h3>
        <div id="notificationList">
            <p style="padding: 20px; color: #666; text-align: center;">No notifications yet</p>
        </div>
    </div>

    <div class="header">
        <div class="header-left">
            <h1>Centiwize</h1>
            <p>Energy ROI Calculator - Netherlands</p>
        </div>
        <div class="header-right">
            <!-- Logged Out State -->
            <div id="authButtons">
                <button class="auth-btn secondary" onclick="openAuthModal('login')">Login</button>
                <button class="auth-btn" onclick="openAuthModal('register')">Sign Up</button>
            </div>
            <!-- Logged In State -->
            <div id="userSection" style="display: none;">
                <div class="notification-badge" onclick="toggleNotifications()">
                    <button style="background: none; border: none; font-size: 1.3rem; cursor: pointer;">üîî</button>
                    <span class="count" id="unreadCount" style="display: none;">0</span>
                </div>
                <div class="user-menu" onclick="toggleUserMenu()">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <span id="userName">User</span>
                    <span>‚ñº</span>
                </div>
            </div>
        </div>
    </div>

    <!-- User Dropdown Menu -->
    <div id="userDropdown" style="display: none; position: absolute; top: 70px; right: 20px; background: white; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); z-index: 999; min-width: 200px;">
        <a href="#" onclick="showDashboard()" style="display: block; padding: 12px 20px; color: #333; text-decoration: none; border-bottom: 1px solid #eee;">üìä My Dashboard</a>
        <a href="#" onclick="showProfile()" style="display: block; padding: 12px 20px; color: #333; text-decoration: none; border-bottom: 1px solid #eee;">üë§ Profile Settings</a>
        <a href="#" onclick="showSavedCalculations()" style="display: block; padding: 12px 20px; color: #333; text-decoration: none; border-bottom: 1px solid #eee;">üíæ Saved Calculations</a>
        <a href="#" onclick="handleLogout()" style="display: block; padding: 12px 20px; color: #e74c3c; text-decoration: none;">üö™ Logout</a>
    </div>

    <div class="container">
        <!-- Dashboard Section (shown when logged in and clicking dashboard) -->
        <div class="dashboard-section" id="dashboardSection">
            <div class="card">
                <h2><span class="icon">üìä</span> My Dashboard</h2>
                <button onclick="hideDashboard()" style="float: right; background: #f0f0f0; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">‚Üê Back to Calculator</button>

                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px;">
                    <div style="background: #e8f5e9; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: #1a5f2a;" id="dashTotalSavings">‚Ç¨0</div>
                        <div style="color: #666;">Potential Annual Savings</div>
                    </div>
                    <div style="background: #fff3e0; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: #e65100;" id="dashProperties">0</div>
                        <div style="color: #666;">Saved Properties</div>
                    </div>
                    <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: #1565c0;" id="dashCalcs">0</div>
                        <div style="color: #666;">Calculations</div>
                    </div>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">Recent Calculations</h3>
                <div id="recentCalculations">
                    <p style="color: #666;">No calculations yet. Use the calculator to get started!</p>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">Latest Updates</h3>
                <div id="latestUpdates">
                    <p style="color: #666;">No updates available.</p>
                </div>
            </div>
        </div>

        <!-- Profile Section -->
        <div class="dashboard-section" id="profileSection">
            <div class="card">
                <h2><span class="icon">üë§</span> Profile Settings</h2>
                <button onclick="hideDashboard()" style="float: right; background: #f0f0f0; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">‚Üê Back</button>

                <div style="margin-top: 20px;">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="profileName" placeholder="Your name">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="profileEmail" disabled style="background: #f0f0f0;">
                    </div>
                    <div class="form-group">
                        <label>Phone (WhatsApp)</label>
                        <input type="tel" id="profilePhone" placeholder="+31 6 12345678">
                    </div>
                    <button class="btn" onclick="saveProfile()">Save Changes</button>
                </div>
            </div>
        </div>

        <!-- Saved Calculations Section -->
        <div class="dashboard-section" id="savedCalcsSection">
            <div class="card">
                <h2><span class="icon">üíæ</span> Saved Calculations</h2>
                <button onclick="hideDashboard()" style="float: right; background: #f0f0f0; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">‚Üê Back</button>

                <div id="savedCalculationsList" style="margin-top: 20px;">
                    <p style="color: #666;">No saved calculations yet.</p>
                </div>
            </div>
        </div>

        <!-- Main Calculator Section -->
        <!-- REQUIRED: Home Size -->
        <div class="card">
            <h2><span class="icon">üè†</span> Home Details <span class="required-badge">Required</span></h2>

            <!-- Address Lookup Section -->
            <div style="background: #f0f7f1; border: 2px solid #2d8f47; border-radius: 10px; padding: 20px; margin-bottom: 25px;">
                <h3 style="color: #1a5f2a; margin-bottom: 15px; font-size: 1rem;">Auto-fill from BAG Register (Official Kadaster Data)</h3>
                <p style="color: #666; font-size: 0.85rem; margin-bottom: 15px;">Enter your address to automatically retrieve floor area, volume, and build year.</p>

                <div class="form-row">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="postalCodeLookup">Postal Code</label>
                        <input type="text" id="postalCodeLookup" placeholder="1012 AB" maxlength="7" pattern="[0-9]{4}\s?[a-zA-Z]{2}" style="text-transform: uppercase;">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="houseNumber">House Number</label>
                        <input type="text" id="houseNumber" placeholder="15" maxlength="10" inputmode="numeric" pattern="[0-9]+">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="houseNumberAddition">Addition</label>
                        <input type="text" id="houseNumberAddition" placeholder="e.g., A, bis" maxlength="10">
                    </div>
                    <div class="form-group" style="margin-bottom: 0; display: flex; align-items: flex-end;">
                        <button type="button" id="lookupBtn" onclick="lookupAddress()" style="background: #2d8f47; color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%;">
                            Lookup
                        </button>
                    </div>
                </div>
                <div id="lookupStatus" style="margin-top: 10px; font-size: 0.9rem; color: #666;"></div>
                <div id="addressResult" style="display: none; margin-top: 15px; padding: 15px; background: white; border-radius: 8px;">
                    <div style="font-weight: 600; color: #1a5f2a;" id="foundAddress"></div>
                    <div style="margin-top: 10px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 0.9rem;">
                        <div><strong>Floor Area:</strong> <span id="wozArea">-</span></div>
                        <div><strong>Volume:</strong> <span id="wozVolume">-</span></div>
                        <div><strong>Build Year:</strong> <span id="wozYear">-</span></div>
                    </div>
                    <button type="button" onclick="applyWozData()" style="margin-top: 15px; background: #1a5f2a; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        Apply to Calculator
                    </button>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="squareMeters">Floor Area (m¬≤)</label>
                    <input type="number" id="squareMeters" placeholder="e.g., 100" min="20" max="500">
                    <div class="hint">Total living space. Typical Dutch home: 50-300 m¬≤</div>
                </div>
                <div class="form-group">
                    <label for="volume">Total Volume (m¬≥)</label>
                    <input type="number" id="volume" placeholder="Auto-calculated or enter manually" min="50" max="2000">
                    <div class="hint">From WOZ data, or floor area √ó ceiling height (default √ó2.5m)</div>
                </div>
            </div>
        </div>

        <!-- REQUIRED: Energy Usage -->
        <div class="card">
            <h2><span class="icon">‚ö°</span> Energy Usage <span class="required-badge">Required</span></h2>

            <div class="energy-method-tabs">
                <button class="active" onclick="switchEnergyMethod('simple', this)">Simple Monthly</button>
                <button onclick="switchEnergyMethod('annual', this)">Annual Statement</button>
                <button onclick="switchEnergyMethod('detailed', this)">Detailed Monthly</button>
            </div>

            <!-- Method A: Simple Monthly -->
            <div id="method-simple" class="energy-method-content active">
                <div class="form-row">
                    <div class="form-group">
                        <label for="monthlyElectric">Average Monthly Electric Bill (‚Ç¨)</label>
                        <input type="number" id="monthlyElectric" placeholder="e.g., 120" min="0">
                        <div class="hint">Sum of 12 months √∑ 12</div>
                    </div>
                    <div class="form-group">
                        <label for="monthlyGas">Average Monthly Gas Bill (‚Ç¨)</label>
                        <input type="number" id="monthlyGas" placeholder="e.g., 150" min="0">
                        <div class="hint">Enter ‚Ç¨0 for all-electric homes</div>
                    </div>
                </div>
            </div>

            <!-- Method B: Annual -->
            <div id="method-annual" class="energy-method-content">
                <div class="form-row">
                    <div class="form-group">
                        <label for="annualElectric">Total Annual Electric Cost (‚Ç¨)</label>
                        <input type="number" id="annualElectric" placeholder="e.g., 1440" min="0">
                        <div class="hint">Find on annual statement: "Totaal Elektriciteit"</div>
                    </div>
                    <div class="form-group">
                        <label for="annualGas">Total Annual Gas Cost (‚Ç¨)</label>
                        <input type="number" id="annualGas" placeholder="e.g., 1800" min="0">
                        <div class="hint">Find on annual statement: "Totaal Aardgas"</div>
                    </div>
                </div>
            </div>

            <!-- Method C: Detailed Monthly -->
            <div id="method-detailed" class="energy-method-content">
                <p style="margin-bottom: 15px; color: #666;">Enter at least 1 month of data. More months = more accurate results.</p>
                <div id="monthly-entries">
                    <div class="form-row" style="margin-bottom: 15px;">
                        <div class="form-group">
                            <label>Month</label>
                            <select>
                                <option>January</option>
                                <option>February</option>
                                <option>March</option>
                                <option>April</option>
                                <option>May</option>
                                <option>June</option>
                                <option>July</option>
                                <option>August</option>
                                <option>September</option>
                                <option>October</option>
                                <option>November</option>
                                <option>December</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Electric Cost (‚Ç¨)</label>
                            <input type="number" placeholder="e.g., 105" min="0">
                        </div>
                        <div class="form-group">
                            <label>Gas Cost (‚Ç¨)</label>
                            <input type="number" placeholder="e.g., 187" min="0">
                        </div>
                    </div>
                </div>
                <button type="button" onclick="addMonthEntry()" style="background: #f0f0f0; border: 1px dashed #999; padding: 10px; width: 100%; border-radius: 8px; cursor: pointer;">+ Add Another Month</button>
            </div>
        </div>

        <!-- REQUIRED: Energy Rates -->
        <div class="card">
            <h2><span class="icon">üí∂</span> Energy Rates <span class="required-badge">Required</span></h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="electricRate">Electric Rate (‚Ç¨/kWh)</label>
                    <input type="number" id="electricRate" placeholder="e.g., 0.30" min="0" step="0.01">
                    <div class="hint">Find on contract: "Elektriciteitstarief"</div>
                </div>
                <div class="form-group">
                    <label for="gasRate">Gas Rate (‚Ç¨/m¬≥)</label>
                    <input type="number" id="gasRate" placeholder="e.g., 1.50" min="0" step="0.01">
                    <div class="hint">Find on contract: "Aardgastarief"</div>
                </div>
            </div>
        </div>

        <!-- REQUIRED: Select Improvements -->
        <div class="card">
            <h2><span class="icon">üîß</span> Energy Improvements <span class="required-badge">Select at least one</span></h2>
            <p style="margin-bottom: 20px; color: #666;">Select the improvements you're considering for your home:</p>

            <div class="improvements-grid">
                <div class="improvement-item" onclick="toggleImprovement(this, 'attic')">
                    <input type="checkbox" id="imp-attic">
                    <span class="name">Attic/Roof Insulation</span>
                    <div class="cost">Est. cost: ‚Ç¨2,500</div>
                    <div class="savings">Up to 20% heating savings</div>
                </div>

                <div class="improvement-item" onclick="toggleImprovement(this, 'walls')">
                    <input type="checkbox" id="imp-walls">
                    <span class="name">Cavity Wall Insulation</span>
                    <div class="cost">Est. cost: ‚Ç¨3,500</div>
                    <div class="savings">Up to 25% heating savings</div>
                </div>

                <div class="improvement-item" onclick="toggleImprovement(this, 'windows')">
                    <input type="checkbox" id="imp-windows">
                    <span class="name">Energy-Efficient Windows</span>
                    <div class="cost">Est. cost: ‚Ç¨7,000</div>
                    <div class="savings">Up to 15% heating savings</div>
                </div>

                <div class="improvement-item" onclick="toggleImprovement(this, 'heating')">
                    <input type="checkbox" id="imp-heating">
                    <span class="name">Heat Pump System</span>
                    <div class="cost">Est. cost: ‚Ç¨10,000</div>
                    <div class="savings">Up to 40% energy savings</div>
                </div>

                <div class="improvement-item" onclick="toggleImprovement(this, 'solar')">
                    <input type="checkbox" id="imp-solar">
                    <span class="name">Solar Panels</span>
                    <div class="cost">Est. cost: ‚Ç¨8,000</div>
                    <div class="savings">Up to 70% electric offset</div>
                </div>

                <div class="improvement-item" onclick="toggleImprovement(this, 'draught')">
                    <input type="checkbox" id="imp-draught">
                    <span class="name">Draught Proofing</span>
                    <div class="cost">Est. cost: ‚Ç¨1,200</div>
                    <div class="savings">Up to 10% heating savings</div>
                </div>

                <div class="improvement-item" onclick="toggleImprovement(this, 'thermostat')">
                    <input type="checkbox" id="imp-thermostat">
                    <span class="name">Smart Thermostat</span>
                    <div class="cost">Est. cost: ‚Ç¨200</div>
                    <div class="savings">Up to 8% heating savings</div>
                </div>
            </div>

            <!-- Solar offset slider (shown when solar is selected) -->
            <div id="solar-options" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                <label for="solarOffset">Electricity offset from solar: <span id="solarOffsetValue">70</span>%</label>
                <input type="range" id="solarOffset" min="30" max="100" value="70" style="width: 100%; margin-top: 10px;" oninput="document.getElementById('solarOffsetValue').textContent = this.value">
            </div>
        </div>

        <!-- OPTIONAL: Additional Details -->
        <div class="card">
            <h2 class="collapsible" onclick="toggleCollapsible(this)"><span class="icon">üìã</span> Additional Details <span class="optional-badge">Optional</span></h2>
            <div class="collapsible-content">
                <p style="margin: 20px 0 20px 0; color: #666;">These fields improve calculation accuracy but are not required.</p>

                <div class="form-row">
                    <div class="form-group">
                        <label for="homeAge">Home Age (years)</label>
                        <input type="number" id="homeAge" placeholder="e.g., 25" min="0" max="200">
                        <div class="hint">Default: 25 years</div>
                    </div>
                    <div class="form-group">
                        <label for="floors">Number of Floors</label>
                        <select id="floors">
                            <option value="">Select...</option>
                            <option value="1">1 floor</option>
                            <option value="1.5">1.5 floors</option>
                            <option value="2">2 floors</option>
                            <option value="3">3+ floors</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="heatingType">Current Heating System</label>
                        <select id="heatingType">
                            <option value="">Select...</option>
                            <option value="gas">Natural Gas Boiler</option>
                            <option value="electric">Electric Heating</option>
                            <option value="heatpump">Heat Pump</option>
                            <option value="oil">Oil Boiler</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="heatingAge">Heating System Age (years)</label>
                        <input type="number" id="heatingAge" placeholder="e.g., 15" min="0" max="50">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="insulationLevel">Current Insulation Level</label>
                        <select id="insulationLevel">
                            <option value="">Select...</option>
                            <option value="none">Minimal/None</option>
                            <option value="poor">Poor (Rc 2.5 or less)</option>
                            <option value="fair">Fair (Rc 3.5)</option>
                            <option value="good">Good (Rc 4.5)</option>
                            <option value="excellent">Excellent (Rc 6.0+)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="windowType">Current Window Type</label>
                        <select id="windowType">
                            <option value="">Select...</option>
                            <option value="single">Single Glazing</option>
                            <option value="double">Double Glazing</option>
                            <option value="hr++">HR++ Double Glazing</option>
                            <option value="triple">Triple Glazing</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="energyLabel">Energy Label</label>
                        <select id="energyLabel">
                            <option value="">Select...</option>
                            <option value="A+++">A+++ / A++++</option>
                            <option value="A+">A+ / A++</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                            <option value="E">E</option>
                            <option value="F">F</option>
                            <option value="G">G</option>
                        </select>
                        <div class="hint">Check: www.ep-online.nl</div>
                    </div>
                    <div class="form-group">
                        <label for="roofOrientation">Roof Orientation</label>
                        <select id="roofOrientation">
                            <option value="">Select...</option>
                            <option value="south">South</option>
                            <option value="east-west">East/West</option>
                            <option value="north">North</option>
                            <option value="flat">Flat Roof</option>
                        </select>
                        <div class="hint">Relevant for solar panel efficiency</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contact Information -->
        <div class="card">
            <h2><span class="icon">üìß</span> Get Your Report</h2>
            <p style="color: #666; margin-bottom: 20px;">Enter your contact details to receive your personalized energy savings report and follow-up consultation.</p>

            <div class="form-row">
                <div class="form-group">
                    <label for="userEmail">Email Address</label>
                    <input type="email" id="userEmail" placeholder="your@email.com" required>
                    <div class="hint">We'll send your detailed report here</div>
                </div>
                <div class="form-group">
                    <label for="userPhone">Phone Number (WhatsApp)</label>
                    <input type="tel" id="userPhone" placeholder="+31 6 12345678">
                    <div class="hint">For follow-up via WhatsApp</div>
                </div>
            </div>

            <div class="form-group">
                <label for="userName">Your Name</label>
                <input type="text" id="userNameInput" placeholder="Your name" required>
            </div>
        </div>

        <!-- Calculate Button -->
        <button class="btn" id="calcBtn" onclick="calculateROI()">Calculate My Savings</button>

        <!-- Results Section -->
        <div class="results" id="results">
            <div class="results-summary">
                <h2><span class="icon">üí∞</span> Your Potential Savings</h2>
                <div class="savings-amount" id="totalSavings">‚Ç¨0</div>
                <div class="savings-period">Estimated annual savings</div>
            </div>

            <div class="card">
                <h2><span class="icon">üìä</span> Detailed Analysis</h2>
                <div class="results-grid">
                    <div class="result-card">
                        <h3>Total Investment</h3>
                        <div class="value" id="totalInvestment">‚Ç¨0</div>
                        <div class="label">One-time cost</div>
                    </div>
                    <div class="result-card">
                        <h3>Payback Period</h3>
                        <div class="value" id="paybackYears">0 years</div>
                        <div class="label">Time to recover investment</div>
                        <div class="payback-bar">
                            <div class="fill" id="paybackFill" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="result-card">
                        <h3>25-Year Savings</h3>
                        <div class="value" id="lifetimeSavings">‚Ç¨0</div>
                        <div class="label">Net profit after payback</div>
                    </div>
                    <div class="result-card">
                        <h3>CO‚ÇÇ Reduction</h3>
                        <div class="value" id="co2Reduction">0 kg</div>
                        <div class="label">Annual emissions saved</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2><span class="icon">üìà</span> Improvement Breakdown</h2>
                <div id="improvementBreakdown"></div>
            </div>

            <!-- Action Buttons -->
            <div class="card" id="actionButtons">
                <h2><span class="icon">üöÄ</span> Next Steps</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <button onclick="saveCalculation()" style="background: linear-gradient(135deg, #1565c0 0%, #1976d2 100%); color: white; border: none; padding: 15px 20px; border-radius: 10px; cursor: pointer; font-size: 1rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span style="font-size: 1.3rem;">üíæ</span> Save to Account
                    </button>
                    <button onclick="sendEmailReport()" style="background: linear-gradient(135deg, #1a5f2a 0%, #2d8f47 100%); color: white; border: none; padding: 15px 20px; border-radius: 10px; cursor: pointer; font-size: 1rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span style="font-size: 1.3rem;">üìß</span> Email Report
                    </button>
                    <button onclick="contactWhatsApp()" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; border: none; padding: 15px 20px; border-radius: 10px; cursor: pointer; font-size: 1rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span style="font-size: 1.3rem;">üí¨</span> WhatsApp
                    </button>
                </div>
                <div id="actionStatus" style="margin-top: 15px; text-align: center; font-size: 0.9rem;"></div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>Energy ROI Calculator - Netherlands Edition</p>
        <p>Helping Dutch homeowners make smart energy decisions</p>
    </footer>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        let BUSINESS_PHONE = '+31612345678';
        let currentUser = null;
        let authEnabled = false;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const configResponse = await fetch('/api/config');
                const config = await configResponse.json();
                BUSINESS_PHONE = config.business_phone || '+31612345678';
                authEnabled = config.auth_enabled || false;

                // Check for existing session
                if (authEnabled) {
                    const sessionResponse = await fetch('/api/auth/session', { credentials: 'include' });
                    const sessionData = await sessionResponse.json();
                    if (sessionData.success && sessionData.user) {
                        currentUser = sessionData.user;
                        await onUserLoggedIn(currentUser);
                    }
                }
            } catch (e) {
                console.log('Init error:', e);
            }
        });

        // ============================================
        // AUTHENTICATION FUNCTIONS
        // ============================================

        function openAuthModal(tab = 'login') {
            document.getElementById('authModal').classList.add('active');
            switchAuthTab(tab);
        }

        function closeAuthModal() {
            document.getElementById('authModal').classList.remove('active');
            document.getElementById('authError').style.display = 'none';
            document.getElementById('authSuccess').style.display = 'none';
        }

        function switchAuthTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('forgotForm').style.display = 'none';
            document.getElementById('authError').style.display = 'none';

            if (tab === 'login') {
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('authModalTitle').textContent = 'Welcome Back';
            } else if (tab === 'register') {
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
                document.getElementById('registerForm').style.display = 'block';
                document.getElementById('authModalTitle').textContent = 'Create Account';
            }
        }

        function showForgotPassword() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('forgotForm').style.display = 'block';
            document.getElementById('authModalTitle').textContent = 'Reset Password';
        }

        function showAuthError(message) {
            const el = document.getElementById('authError');
            el.textContent = message;
            el.style.display = 'block';
        }

        function showAuthSuccess(message) {
            const el = document.getElementById('authSuccess');
            el.textContent = message;
            el.style.display = 'block';
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showAuthError('Please enter email and password.');
                return;
            }

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (!data.success) {
                    showAuthError(data.error || 'Login failed');
                    return;
                }

                currentUser = data.user;
                await onUserLoggedIn(currentUser);
                closeAuthModal();
            } catch (error) {
                showAuthError(error.message);
            }
        }

        async function handleRegister() {
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;

            if (!email || !password) {
                showAuthError('Please enter email and password.');
                return;
            }

            if (password.length < 6) {
                showAuthError('Password must be at least 6 characters.');
                return;
            }

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ email, password, name })
                });

                const data = await response.json();

                if (!data.success) {
                    showAuthError(data.error || 'Registration failed');
                    return;
                }

                if (data.user && data.session) {
                    currentUser = data.user;
                    await onUserLoggedIn(currentUser);
                    closeAuthModal();
                } else {
                    showAuthSuccess('Account created! Please check your email to verify.');
                }
            } catch (error) {
                showAuthError(error.message);
            }
        }

        async function handleForgotPassword() {
            const email = document.getElementById('forgotEmail').value.trim();

            if (!email) {
                showAuthError('Please enter your email.');
                return;
            }

            try {
                const response = await fetch(`/api/auth/forgot-password?email=${encodeURIComponent(email)}`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (!data.success) {
                    showAuthError(data.error || 'Failed to send reset email');
                    return;
                }

                showAuthSuccess('Password reset link sent! Check your email.');
            } catch (error) {
                showAuthError(error.message);
            }
        }

        async function handleOAuthLogin(provider) {
            try {
                localStorage.setItem('auth_redirect', window.location.pathname);
                const response = await fetch(`/api/auth/oauth/${provider}`);
                const data = await response.json();
                if (data.url) {
                    window.location.href = data.url;
                } else {
                    showAuthError('Failed to start OAuth login');
                }
            } catch (error) {
                showAuthError(error.message);
            }
        }

        async function handleLogout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
            } catch (e) {}
            currentUser = null;
            onUserLoggedOut();
            document.getElementById('userDropdown').style.display = 'none';
        }

        async function onUserLoggedIn(user) {
            document.getElementById('authButtons').style.display = 'none';
            document.getElementById('userSection').style.display = 'flex';

            // Set user info
            const name = user.user_metadata?.full_name || (user.email ? user.email.split('@')[0] : (user.phone || 'User'));
            document.getElementById('userName').textContent = name;
            document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();

            // Pre-fill contact form if on calculator
            const nameField = document.getElementById('userNameInput');
            const emailField = document.getElementById('userEmail');
            if (nameField) nameField.value = name;
            if (emailField) emailField.value = user.email;

            // Load notifications
            await loadNotifications();

            // Subscribe to realtime
            subscribeToNotifications();
        }

        function onUserLoggedOut() {
            document.getElementById('authButtons').style.display = 'flex';
            document.getElementById('userSection').style.display = 'none';
            document.getElementById('userDropdown').style.display = 'none';
            currentUser = null;
        }

        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
            document.getElementById('notificationPanel').classList.remove('active');
        }

        function toggleNotifications() {
            document.getElementById('notificationPanel').classList.toggle('active');
            document.getElementById('userDropdown').style.display = 'none';
        }

        // ============================================
        // NOTIFICATION FUNCTIONS
        // ============================================

        async function loadNotifications() {
            if (!currentUser) return;

            try {
                const response = await fetch('/api/notifications', { credentials: 'include' });
                const data = await response.json();

                if (data.success) {
                    renderNotifications(data.notifications || []);
                }
            } catch (error) {
                console.error('Load notifications error:', error);
            }
        }

        function renderNotifications(notifications) {
            const list = document.getElementById('notificationList');
            const unreadCount = notifications.filter(n => !n.read).length;

            document.getElementById('unreadCount').textContent = unreadCount;
            document.getElementById('unreadCount').style.display = unreadCount > 0 ? 'inline' : 'none';
            document.getElementById('notifCount').textContent = `(${notifications.length})`;

            if (notifications.length === 0) {
                list.innerHTML = '<p style="padding: 20px; color: #666; text-align: center;">No notifications yet</p>';
                return;
            }

            list.innerHTML = notifications.map(n => `
                <div class="notification-item ${n.read ? '' : 'unread'}" onclick="markNotificationRead('${n.id}')">
                    <div class="title">${n.title}</div>
                    <div class="message">${n.message}</div>
                    <div class="time">${new Date(n.created_at).toLocaleDateString()}</div>
                </div>
            `).join('');
        }

        async function markNotificationRead(id) {
            if (!currentUser) return;

            try {
                await fetch(`/api/notifications/${id}/read`, {
                    method: 'PUT',
                    credentials: 'include'
                });
                await loadNotifications();
            } catch (error) {
                console.error('Mark read error:', error);
            }
        }

        function subscribeToNotifications() {
            // Poll for new notifications every 60 seconds
            if (!currentUser) return;
            setInterval(() => {
                if (currentUser) loadNotifications();
            }, 60000);
        }

        function showToast(title, message) {
            const toast = document.createElement('div');
            toast.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: #1a5f2a; color: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 9999; animation: slideIn 0.3s ease;';
            toast.innerHTML = `<strong>${title}</strong><br><span style="font-size: 0.9rem;">${message}</span>`;
            document.body.appendChild(toast);

            setTimeout(() => toast.remove(), 5000);
        }

        // ============================================
        // DASHBOARD FUNCTIONS
        // ============================================

        function showDashboard() {
            hideAllDashboardSections();
            document.getElementById('dashboardSection').classList.add('active');
            document.getElementById('userDropdown').style.display = 'none';
            loadDashboardData();
        }

        function showProfile() {
            hideAllDashboardSections();
            document.getElementById('profileSection').classList.add('active');
            document.getElementById('userDropdown').style.display = 'none';
            loadProfileData();
        }

        function showSavedCalculations() {
            hideAllDashboardSections();
            document.getElementById('savedCalcsSection').classList.add('active');
            document.getElementById('userDropdown').style.display = 'none';
            loadSavedCalculations();
        }

        function hideDashboard() {
            hideAllDashboardSections();
        }

        function hideAllDashboardSections() {
            document.querySelectorAll('.dashboard-section').forEach(s => s.classList.remove('active'));
        }

        async function loadDashboardData() {
            if (!currentUser) return;

            try {
                const response = await fetch('/api/calculations', { credentials: 'include' });
                const data = await response.json();
                const calcs = data.calculations || [];

                const totalSavings = calcs.reduce((sum, c) => sum + (c.annual_savings || 0), 0);

                document.getElementById('dashTotalSavings').textContent = `‚Ç¨${Math.round(totalSavings).toLocaleString()}`;
                document.getElementById('dashProperties').textContent = '0';
                document.getElementById('dashCalcs').textContent = calcs.length;

                renderRecentCalculations(calcs.slice(0, 5));
                renderLatestUpdates([]);

            } catch (error) {
                console.error('Dashboard load error:', error);
            }
        }

        function renderRecentCalculations(calcs) {
            const container = document.getElementById('recentCalculations');

            if (calcs.length === 0) {
                container.innerHTML = '<p style="color: #666;">No calculations yet. Use the calculator to get started!</p>';
                return;
            }

            container.innerHTML = calcs.map(c => `
                <div class="saved-calc-item">
                    <div class="info">
                        <h4>${c.improvements?.join(', ') || 'Calculation'}</h4>
                        <p>${new Date(c.created_at).toLocaleDateString()} ‚Ä¢ Payback: ${c.payback_years} years</p>
                    </div>
                    <div class="savings">‚Ç¨${Math.round(c.annual_savings || 0).toLocaleString()}/yr</div>
                </div>
            `).join('');
        }

        function renderLatestUpdates(updates) {
            const container = document.getElementById('latestUpdates');

            if (updates.length === 0) {
                container.innerHTML = '<p style="color: #666;">No updates available.</p>';
                return;
            }

            container.innerHTML = updates.map(u => `
                <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                    <strong>${u.title}</strong>
                    <p style="margin: 5px 0 0; font-size: 0.9rem; color: #666;">${u.description}</p>
                </div>
            `).join('');
        }

        async function loadProfileData() {
            if (!currentUser) return;

            document.getElementById('profileEmail').value = currentUser.email || '';
            document.getElementById('profileName').value = currentUser.user_metadata?.full_name || '';

            try {
                const response = await fetch('/api/profile', { credentials: 'include' });
                const data = await response.json();
                if (data.success && data.profile) {
                    document.getElementById('profilePhone').value = data.profile.phone || '';
                    if (data.profile.full_name) {
                        document.getElementById('profileName').value = data.profile.full_name;
                    }
                }
            } catch (e) {
                document.getElementById('profilePhone').value = '';
            }
        }

        async function saveProfile() {
            if (!currentUser) return;

            const name = document.getElementById('profileName').value.trim();
            const phone = document.getElementById('profilePhone').value.trim();

            try {
                const response = await fetch('/api/profile', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ full_name: name, phone: phone })
                });

                const data = await response.json();
                if (data.success) {
                    alert('Profile saved!');
                } else {
                    alert('Error saving profile: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error saving profile: ' + error.message);
            }
        }

        async function loadSavedCalculations() {
            if (!currentUser) return;

            try {
                const response = await fetch('/api/calculations', {
                    credentials: 'include'
                });
                const data = await response.json();

                const container = document.getElementById('savedCalculationsList');

                if (!data.success || !data.calculations || data.calculations.length === 0) {
                    container.innerHTML = '<p style="color: #666;">No saved calculations yet.</p>';
                    return;
                }

                const calcs = data.calculations;
                container.innerHTML = calcs.map(c => `
                    <div class="saved-calc-item">
                        <div class="info">
                            <h4>${c.properties?.address || 'Unknown Property'}</h4>
                            <p>${c.improvements?.join(', ') || 'No improvements'}</p>
                            <p style="font-size: 0.8rem; color: #999;">${new Date(c.created_at).toLocaleString()}</p>
                        </div>
                        <div style="text-align: right;">
                            <div class="savings">‚Ç¨${Math.round(c.annual_savings || 0).toLocaleString()}/yr</div>
                            <p style="font-size: 0.85rem; color: #666;">Payback: ${c.payback_years} years</p>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Load saved calcs error:', error);
            }
        }

        // ============================================
        // SAVE CALCULATION FUNCTION
        // ============================================

        async function saveCalculation() {
            if (!currentUser) {
                openAuthModal('register');
                return;
            }

            if (!lastCalculation) {
                alert('Please calculate first.');
                return;
            }

            const saveBtn = event?.target?.closest('button');
            if (saveBtn) { saveBtn.disabled = true; saveBtn.style.opacity = '0.7'; }

            try {
                const response = await fetch('/api/calculations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        property: wozData?.address ? {
                            address: wozData.address,
                            postal_code: document.getElementById('postalCodeLookup')?.value || '',
                            house_number: document.getElementById('houseNumber')?.value || '',
                            area_m2: parseInt(document.getElementById('squareMeters').value) || null,
                            volume_m3: parseInt(document.getElementById('volume').value) || null,
                            build_year: wozData.buildYear || null
                        } : null,
                        calculation: {
                            improvements: lastCalculation.improvements,
                            annual_savings: lastCalculation.annualSavings,
                            total_investment: lastCalculation.totalInvestment,
                            payback_years: parseFloat(lastCalculation.paybackYears),
                            lifetime_savings: lastCalculation.lifetimeSavings,
                            co2_reduction: lastCalculation.co2Reduction
                        }
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to save calculation');
                }

                showToast('Saved!', 'Your calculation has been saved to your account.');

            } catch (error) {
                console.error('Save calculation error:', error);
                alert('Error saving: ' + error.message);
            } finally {
                if (saveBtn) { saveBtn.disabled = false; saveBtn.style.opacity = '1'; }
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.user-menu') && !e.target.closest('#userDropdown')) {
                document.getElementById('userDropdown').style.display = 'none';
            }
            if (!e.target.closest('.notification-badge') && !e.target.closest('#notificationPanel')) {
                document.getElementById('notificationPanel').classList.remove('active');
            }
        });

        // ============================================
        // ORIGINAL CALCULATOR CODE
        // ============================================

        // Store BAG lookup result
        let wozData = null;

        // Address lookup using backend API
        async function lookupAddress() {
            const postalCode = document.getElementById('postalCodeLookup').value.replace(/\s/g, '').toUpperCase();
            const houseNumber = document.getElementById('houseNumber').value.trim();
            const houseNumberAddition = document.getElementById('houseNumberAddition').value.trim();
            const statusEl = document.getElementById('lookupStatus');
            const resultEl = document.getElementById('addressResult');
            const lookupBtn = document.getElementById('lookupBtn');

            // Validate inputs
            if (!postalCode || !houseNumber) {
                statusEl.innerHTML = '<span style="color: #e74c3c;">Please enter both postal code and house number</span>';
                return;
            }

            // Validate postal code format (1234AB)
            if (!/^\d{4}[A-Z]{2}$/.test(postalCode)) {
                statusEl.innerHTML = '<span style="color: #e74c3c;">Invalid postal code format. Use: 1234AB</span>';
                return;
            }

            statusEl.innerHTML = '<span style="color: #2d8f47;">Looking up address...</span>';
            lookupBtn.disabled = true;
            lookupBtn.textContent = 'Searching...';

            try {
                // Call backend API
                let apiUrl = `/api/lookup?postcode=${postalCode}&huisnummer=${houseNumber}`;
                if (houseNumberAddition) {
                    apiUrl += `&toevoeging=${encodeURIComponent(houseNumberAddition)}`;
                }

                const response = await fetch(apiUrl);
                const data = await response.json();

                if (!response.ok) {
                    statusEl.innerHTML = `<span style="color: #e74c3c;">${data.detail || 'Error looking up address'}</span>`;
                    resultEl.style.display = 'none';
                    lookupBtn.disabled = false;
                    lookupBtn.textContent = 'Lookup';
                    return;
                }

                if (!data.success) {
                    statusEl.innerHTML = `<span style="color: #e74c3c;">${data.error || 'Address not found'}</span>`;
                    resultEl.style.display = 'none';
                    lookupBtn.disabled = false;
                    lookupBtn.textContent = 'Lookup';
                    return;
                }

                // Store data
                wozData = {
                    area: data.area,
                    volume: data.volume,
                    buildYear: data.build_year,
                    ceilingHeight: data.ceiling_height,
                    address: data.address,
                    estimated: data.estimated
                };

                // Display results
                document.getElementById('foundAddress').textContent = data.address;
                document.getElementById('wozArea').textContent = data.area
                    ? (data.estimated ? `~${data.area} m¬≤ (estimated)` : `${data.area} m¬≤`)
                    : 'Not available';
                document.getElementById('wozVolume').textContent = data.volume
                    ? `${data.volume} m¬≥`
                    : 'Not available';
                document.getElementById('wozYear').textContent = data.build_year || 'Unknown';

                resultEl.style.display = 'block';

                const sourceText = data.source === 'kadaster'
                    ? 'Official BAG data from Kadaster'
                    : 'Data from PDOK';
                statusEl.innerHTML = `<span style="color: #2d8f47;">‚úì ${sourceText}${data.estimated ? ' (some values estimated)' : ''}</span>`;

            } catch (error) {
                console.error('Lookup error:', error);
                statusEl.innerHTML = '<span style="color: #e74c3c;">Connection error. Please try again.</span>';
                resultEl.style.display = 'none';
            }

            lookupBtn.disabled = false;
            lookupBtn.textContent = 'Lookup';
        }

        // Apply WOZ data to the form
        function applyWozData() {
            if (!wozData) return;

            document.getElementById('squareMeters').value = wozData.area;
            document.getElementById('volume').value = wozData.volume;

            // Also set home age if available
            if (wozData.buildYear) {
                const currentYear = new Date().getFullYear();
                const homeAge = currentYear - wozData.buildYear;
                document.getElementById('homeAge').value = homeAge;
            }

            // Scroll to show applied values
            document.getElementById('squareMeters').scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Flash effect to show values changed
            ['squareMeters', 'volume', 'homeAge'].forEach(id => {
                const el = document.getElementById(id);
                if (el.value) {
                    el.style.transition = 'background-color 0.3s';
                    el.style.backgroundColor = '#d4edda';
                    setTimeout(() => {
                        el.style.backgroundColor = '';
                    }, 1500);
                }
            });
        }

        // Store calculation results for report
        let lastCalculation = null;

        // Send email report via backend
        async function sendEmailReport() {
            const email = document.getElementById('userEmail').value.trim();
            const name = document.getElementById('userNameInput').value.trim();
            const statusEl = document.getElementById('actionStatus');
            const emailBtn = event?.target?.closest('button');

            if (!email) {
                statusEl.innerHTML = '<span style="color: #e74c3c;">Please enter your email address above.</span>';
                document.getElementById('userEmail').scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }

            if (!lastCalculation) {
                statusEl.innerHTML = '<span style="color: #e74c3c;">Please calculate your savings first.</span>';
                return;
            }

            if (emailBtn) { emailBtn.disabled = true; emailBtn.style.opacity = '0.7'; }
            statusEl.innerHTML = '<span style="color: #2d8f47;">Sending your report...</span>';

            try {
                const response = await fetch('/api/send-report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        name: name || 'Homeowner',
                        address: wozData?.address || 'Not provided',
                        area: document.getElementById('squareMeters').value,
                        volume: document.getElementById('volume').value,
                        ...lastCalculation
                    })
                });

                const data = await response.json();

                if (data.success) {
                    statusEl.innerHTML = '<span style="color: #2d8f47;">‚úì Report sent! Check your inbox.</span>';
                } else {
                    statusEl.innerHTML = `<span style="color: #e74c3c;">${data.error || 'Failed to send. Please try again.'}</span>`;
                }
            } catch (error) {
                console.error('Email error:', error);
                statusEl.innerHTML = '<span style="color: #e74c3c;">Connection error. Please try again.</span>';
            } finally {
                if (emailBtn) { emailBtn.disabled = false; emailBtn.style.opacity = '1'; }
            }
        }

        // Open WhatsApp with pre-filled message
        function contactWhatsApp() {
            const phone = document.getElementById('userPhone').value.trim();
            const name = document.getElementById('userNameInput').value.trim() || 'A homeowner';
            const statusEl = document.getElementById('actionStatus');

            // Business WhatsApp number from config
            const businessPhone = BUSINESS_PHONE.replace(/[^0-9]/g, ''); // Remove non-digits

            // Build message with calculation results
            let message = `Hi! I'm ${name} and I just used the Centiwize Energy Calculator.\n\n`;

            if (wozData?.address) {
                message += `üìç Property: ${wozData.address}\n`;
            }

            if (lastCalculation) {
                message += `\nüìä My Results:\n`;
                message += `‚Ä¢ Annual Savings: ‚Ç¨${lastCalculation.annualSavings}\n`;
                message += `‚Ä¢ Investment: ‚Ç¨${lastCalculation.totalInvestment}\n`;
                message += `‚Ä¢ Payback: ${lastCalculation.paybackYears} years\n`;
                message += `\nI'd like to discuss my energy improvement options.`;
            } else {
                message += `I'd like to learn more about energy improvements for my home.`;
            }

            // Create WhatsApp URL
            const whatsappUrl = `https://wa.me/${businessPhone}?text=${encodeURIComponent(message)}`;

            // Open WhatsApp
            window.open(whatsappUrl, '_blank');

            statusEl.innerHTML = '<span style="color: #25D366;">‚úì Opening WhatsApp...</span>';
        }

        // Loading state helper
        function setButtonLoading(btn, loading, originalText) {
            if (!btn) return;
            btn.disabled = loading;
            btn.style.opacity = loading ? '0.7' : '1';
            btn.textContent = loading ? 'Processing...' : originalText;
        }

        // Track selected improvements
        const selectedImprovements = new Set();

        // Improvement data
        const improvements = {
            attic: { name: 'Attic/Roof Insulation', cost: 2500, savingsPercent: 0.20, type: 'heating' },
            walls: { name: 'Cavity Wall Insulation', cost: 3500, savingsPercent: 0.25, type: 'heating' },
            windows: { name: 'Energy-Efficient Windows', cost: 7000, savingsPercent: 0.15, type: 'heating' },
            heating: { name: 'Heat Pump System', cost: 10000, savingsPercent: 0.40, type: 'both' },
            solar: { name: 'Solar Panels', cost: 8000, savingsPercent: 0.70, type: 'electric' },
            draught: { name: 'Draught Proofing', cost: 1200, savingsPercent: 0.10, type: 'heating' },
            thermostat: { name: 'Smart Thermostat', cost: 200, savingsPercent: 0.08, type: 'heating' }
        };

        function toggleImprovement(element, id) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            element.classList.toggle('selected', checkbox.checked);

            if (checkbox.checked) {
                selectedImprovements.add(id);
            } else {
                selectedImprovements.delete(id);
            }

            // Show/hide solar options
            document.getElementById('solar-options').style.display =
                selectedImprovements.has('solar') ? 'block' : 'none';
        }

        function switchEnergyMethod(method, clickedBtn) {
            // Update tabs
            const tabs = document.querySelectorAll('.energy-method-tabs button');
            tabs.forEach(btn => btn.classList.remove('active'));
            if (clickedBtn) {
                clickedBtn.classList.add('active');
            } else {
                // Fallback: activate by method index
                const methodIndex = { simple: 0, annual: 1, detailed: 2 };
                if (tabs[methodIndex[method]]) tabs[methodIndex[method]].classList.add('active');
            }

            // Update content
            document.querySelectorAll('.energy-method-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById('method-' + method).classList.add('active');
        }

        function addMonthEntry() {
            const container = document.getElementById('monthly-entries');
            const entry = document.createElement('div');
            entry.className = 'form-row';
            entry.style.marginBottom = '15px';
            entry.innerHTML = `
                <div class="form-group">
                    <label>Month</label>
                    <select>
                        <option>January</option>
                        <option>February</option>
                        <option>March</option>
                        <option>April</option>
                        <option>May</option>
                        <option>June</option>
                        <option>July</option>
                        <option>August</option>
                        <option>September</option>
                        <option>October</option>
                        <option>November</option>
                        <option>December</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Electric Cost (‚Ç¨)</label>
                    <input type="number" placeholder="e.g., 105" min="0">
                </div>
                <div class="form-group">
                    <label>Gas Cost (‚Ç¨)</label>
                    <input type="number" placeholder="e.g., 187" min="0">
                </div>
            `;
            container.appendChild(entry);
        }

        function toggleCollapsible(element) {
            element.classList.toggle('open');
            const content = element.nextElementSibling;
            content.classList.toggle('open');
        }

        function calculateROI() {
            // Validate required inputs
            const errors = [];
            const sqmVal = parseFloat(document.getElementById('squareMeters').value);
            const volVal = parseFloat(document.getElementById('volume').value);

            if (!sqmVal || sqmVal < 20 || sqmVal > 500) {
                errors.push('Floor Area must be between 20 and 500 m¬≤.');
            }
            if (volVal && (volVal < 50 || volVal > 2000)) {
                errors.push('Total Volume must be between 50 and 2,000 m¬≥.');
            }
            if (selectedImprovements.size === 0) {
                errors.push('Please select at least one energy improvement.');
            }

            if (errors.length > 0) {
                alert('Please fix the following:\n\n‚Ä¢ ' + errors.join('\n‚Ä¢ '));
                return;
            }

            // Get input values
            const squareMeters = sqmVal;
            const volume = volVal || squareMeters * 2.5;

            // Get energy costs (from active method)
            let annualElectricCost = 0;
            let annualGasCost = 0;

            const activeMethod = document.querySelector('.energy-method-content.active').id;

            if (activeMethod === 'method-simple') {
                annualElectricCost = (parseFloat(document.getElementById('monthlyElectric').value) || 120) * 12;
                annualGasCost = (parseFloat(document.getElementById('monthlyGas').value) || 150) * 12;
            } else if (activeMethod === 'method-annual') {
                annualElectricCost = parseFloat(document.getElementById('annualElectric').value) || 1440;
                annualGasCost = parseFloat(document.getElementById('annualGas').value) || 1800;
            } else {
                // Detailed method - sum up entries
                const entries = document.querySelectorAll('#monthly-entries .form-row');
                entries.forEach(entry => {
                    const inputs = entry.querySelectorAll('input');
                    annualElectricCost += parseFloat(inputs[0].value) || 0;
                    annualGasCost += parseFloat(inputs[1].value) || 0;
                });
                // Annualize if less than 12 months
                const monthCount = entries.length;
                if (monthCount > 0 && monthCount < 12) {
                    annualElectricCost = (annualElectricCost / monthCount) * 12;
                    annualGasCost = (annualGasCost / monthCount) * 12;
                }
            }

            const totalAnnualEnergy = annualElectricCost + annualGasCost;

            // Calculate savings from selected improvements
            let totalInvestment = 0;
            let totalAnnualSavings = 0;
            let breakdownHtml = '';

            // Track savings to avoid double-counting
            let heatingSavingsPercent = 0;
            let electricSavingsPercent = 0;

            selectedImprovements.forEach(id => {
                const imp = improvements[id];
                totalInvestment += imp.cost;

                let savingsAmount = 0;

                if (imp.type === 'heating') {
                    // Diminishing returns for stacking insulation
                    const effectivePercent = imp.savingsPercent * (1 - heatingSavingsPercent * 0.3);
                    savingsAmount = annualGasCost * effectivePercent;
                    heatingSavingsPercent += imp.savingsPercent;
                } else if (imp.type === 'electric') {
                    // Solar panels
                    const solarOffset = parseFloat(document.getElementById('solarOffset').value) / 100;
                    savingsAmount = annualElectricCost * solarOffset;
                    electricSavingsPercent = solarOffset;
                } else if (imp.type === 'both') {
                    // Heat pump affects both
                    savingsAmount = (annualGasCost * 0.35) + (annualElectricCost * 0.1);
                }

                totalAnnualSavings += savingsAmount;

                breakdownHtml += `
                    <div style="display: flex; justify-content: space-between; padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;">
                        <div>
                            <strong>${imp.name}</strong>
                            <div style="color: #666; font-size: 0.9rem;">Investment: ‚Ç¨${imp.cost.toLocaleString()}</div>
                        </div>
                        <div style="text-align: right;">
                            <strong style="color: #2d8f47;">‚Ç¨${Math.round(savingsAmount).toLocaleString()}/year</strong>
                            <div style="color: #666; font-size: 0.9rem;">Payback: ${(imp.cost / savingsAmount).toFixed(1)} years</div>
                        </div>
                    </div>
                `;
            });

            // Calculate results
            const paybackYears = totalInvestment / totalAnnualSavings;
            const lifetimeSavings = (totalAnnualSavings * 25) - totalInvestment;
            const co2Reduction = Math.round((annualGasCost / 1.5) * 1.8 * (heatingSavingsPercent || 0.2)); // kg CO2

            // Update display
            document.getElementById('totalSavings').textContent = `‚Ç¨${Math.round(totalAnnualSavings).toLocaleString()}`;
            document.getElementById('totalInvestment').textContent = `‚Ç¨${totalInvestment.toLocaleString()}`;
            document.getElementById('paybackYears').textContent = `${paybackYears.toFixed(1)} years`;
            document.getElementById('lifetimeSavings').textContent = `‚Ç¨${Math.round(lifetimeSavings).toLocaleString()}`;
            document.getElementById('co2Reduction').textContent = `${co2Reduction.toLocaleString()} kg`;
            document.getElementById('improvementBreakdown').innerHTML = breakdownHtml || '<p style="color: #666;">Select at least one improvement above to see breakdown.</p>';

            // Animate payback bar (max 15 years = 100%)
            const paybackPercent = Math.min((paybackYears / 15) * 100, 100);
            setTimeout(() => {
                document.getElementById('paybackFill').style.width = paybackPercent + '%';
            }, 100);

            // Store calculation for email/WhatsApp
            lastCalculation = {
                annualSavings: Math.round(totalAnnualSavings),
                totalInvestment: totalInvestment,
                paybackYears: paybackYears.toFixed(1),
                lifetimeSavings: Math.round(lifetimeSavings),
                co2Reduction: co2Reduction,
                improvements: Array.from(selectedImprovements).map(id => improvements[id].name)
            };

            // Show results
            document.getElementById('results').classList.add('visible');
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });

            // Flash the calculate button to indicate success
            const calcBtn = document.getElementById('calcBtn');
            calcBtn.textContent = '‚úì Calculated!';
            calcBtn.style.background = '#2d8f47';
            setTimeout(() => {
                calcBtn.textContent = 'Calculate My Savings';
                calcBtn.style.background = '';
            }, 2000);
        }

        // Auto-calculate volume when square meters changes
        document.getElementById('squareMeters').addEventListener('input', function() {
            const volumeField = document.getElementById('volume');
            if (!volumeField.value) {
                volumeField.placeholder = `Auto: ${(this.value * 2.5).toFixed(0)} m¬≥`;
            }
        });

        // Expose all onclick functions to global scope
        window.closeAuthModal = closeAuthModal;
        window.switchAuthTab = switchAuthTab;
        window.showForgotPassword = showForgotPassword;
        window.handleLogin = handleLogin;
        window.handleRegister = handleRegister;
        window.handleForgotPassword = handleForgotPassword;
        window.handleOAuthLogin = handleOAuthLogin;
        window.handleLogout = handleLogout;
        window.toggleUserMenu = toggleUserMenu;
        window.toggleNotifications = toggleNotifications;
        window.markNotificationRead = markNotificationRead;
        window.showDashboard = showDashboard;
        window.showProfile = showProfile;
        window.showSavedCalculations = showSavedCalculations;
        window.hideDashboard = hideDashboard;
        window.saveProfile = saveProfile;
        window.lookupAddress = lookupAddress;
        window.applyWozData = applyWozData;
        window.toggleCollapsible = toggleCollapsible;
        window.switchEnergyMethod = switchEnergyMethod;
        window.addMonthEntry = addMonthEntry;
        window.toggleImprovement = toggleImprovement;
        window.calculateROI = calculateROI;
        window.saveCalculation = saveCalculation;
        window.sendEmailReport = sendEmailReport;
        window.contactWhatsApp = contactWhatsApp;

        console.log('All functions exposed to window. Script fully loaded.');
    </script>
</body>
</html>
